<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Test - ONN Geospatial Search</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .test-container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
    }

    input {
      padding: 10px;
      width: 200px;
      margin-right: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .results {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      white-space: pre-wrap;
      font-family: monospace;
    }

    .error {
      color: red;
    }

    .success {
      color: green;
    }
  </style>
</head>

<body>
  <div class="test-container">
    <h1>üß™ ONN Geospatial Search Test</h1>
    <p>This page tests the geocoding functionality using direct Mapbox API calls (for local testing only).</p>

    <div>
      <input type="text" id="zipInput" placeholder="Enter zip code" value="10001">
      <button onclick="testGeocode()">Test Geocode</button>
    </div>

    <div id="results" class="results"></div>
  </div>

  <script>
    const MAPBOX_API_KEY = 'pk.eyJ1Ijoibi1oYXNzYW43IiwiYSI6ImNtaXJ1cnQzZTB2N20zaHB1MnhqZzR0d2EifQ.VMhWXab7SZnnj7A9BJ51gw';

    async function testGeocode() {
      const zipCode = document.getElementById('zipInput').value.trim();
      const resultsDiv = document.getElementById('results');

      resultsDiv.innerHTML = '‚è≥ Testing geocode for: ' + zipCode + '\n\n';

      if (!/^\d{5}$/.test(zipCode)) {
        resultsDiv.innerHTML += '<span class="error">‚ùå Invalid zip code format</span>';
        return;
      }

      try {
        // Test 1: Geocode the zip code
        resultsDiv.innerHTML += '1Ô∏è‚É£ Calling Mapbox API...\n';
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${zipCode}.json?access_token=${MAPBOX_API_KEY}&country=US&types=postcode&limit=1`;

        const response = await fetch(url);

        if (!response.ok) {
          throw new Error(`API returned ${response.status}`);
        }

        const data = await response.json();

        if (!data.features || data.features.length === 0) {
          resultsDiv.innerHTML += '<span class="error">‚ùå Zip code not found</span>';
          return;
        }

        const [longitude, latitude] = data.features[0].center;
        resultsDiv.innerHTML += `<span class="success">‚úÖ Geocoded successfully!</span>\n`;
        resultsDiv.innerHTML += `   Latitude: ${latitude}\n`;
        resultsDiv.innerHTML += `   Longitude: ${longitude}\n\n`;

        // Test 2: Calculate distances to stores
        resultsDiv.innerHTML += '2Ô∏è‚É£ Calculating distances to stores...\n';

        // Sample stores from your data
        const testStores = [
          { name: "Vintage Vogue", lat: 40.7489, lon: -73.9897 },
          { name: "Thrift & Thrive", lat: 40.6895, lon: -73.9876 },
          { name: "The Luxe Closet", lat: 40.7714, lon: -73.9632 }
        ];

        testStores.forEach(store => {
          const distance = calculateDistance(latitude, longitude, store.lat, store.lon);
          resultsDiv.innerHTML += `   ${store.name}: ${distance.toFixed(1)} miles\n`;
        });

        resultsDiv.innerHTML += '\n<span class="success">‚úÖ All tests passed!</span>\n';
        resultsDiv.innerHTML += '\nüí° Your geospatial search is working correctly!\n';
        resultsDiv.innerHTML += '   Deploy to Netlify to use it on your live site.';

      } catch (error) {
        resultsDiv.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
        resultsDiv.innerHTML += '\nPossible issues:\n';
        resultsDiv.innerHTML += '- CORS restrictions (expected for local testing)\n';
        resultsDiv.innerHTML += '- Invalid API key\n';
        resultsDiv.innerHTML += '- Network connectivity\n';
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = toRadians(lat2 - lat1);
      const dLon = toRadians(lon2 - lon1);

      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function toRadians(degrees) {
      return degrees * (Math.PI / 180);
    }

    // Auto-run test on load
    window.onload = () => testGeocode();
  </script>
</body>

</html>